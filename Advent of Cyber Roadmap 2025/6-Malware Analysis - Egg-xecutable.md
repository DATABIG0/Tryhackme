
Introduction

![[Pasted image 20251206154106.png]]

El pueblo de Wareville permanece en silencio en plena noche. Mientras los residentes de Wareville están cómodamente arropados en sus camas, felizmente desprevenidos, el equipo del SOC de The Best Festival Company (TBFC) permanece alerta, preparado y preparado para lo que les pueda suceder.

Controlando sus pantallas, armados con una taza de chocolate caliente recién hecho, los elfos del SOC observan sus paneles con atención.

De repente, los elfos reciben un correo electrónico al unísono de Elf McClause, Jefe de Asuntos Élficos, en sus bandejas de entrada. Dice:

![[Pasted image 20251206154138.png]]

Jefe de Asuntos de Elf
"¿Por qué Elf McClause trabaja a las 3 de la madrugada?", grita un miembro del equipo del SOC de fondo. Tienen razón, algo anda mal.

Elf McBlue sospecha de inmediato. Sus años de experiencia en el SOC le han dado la sabiduría para no descargar ejecutables de la nada. Sin la ayuda de McSkidy, Elf McBlue toma las riendas, cargando su kit de herramientas de investigación de malware y comienza la investigación.

Objetivos de aprendizaje

En la sala de hoy, asumirás el papel de Elf McBlue, un talentoso miembro del equipo de investigación de malware de The Best Festival Company. Se te ha encomendado investigar un ejecutable altamente sospechoso que se comparte dentro de la empresa. En la sala de hoy, abordaremos los siguientes temas:

- Principios del análisis de malware
- Introducción a los entornos de pruebas
- Análisis estático vs. dinámico
- Herramientas del oficio: PeStudio, ProcMon, Regshot


---

# ==Malware Analysis Using Sandboxes==

## Principios del Análisis de Malware

El análisis de malware consiste en examinar un archivo malicioso para comprender su funcionalidad, funcionamiento y métodos de defensa. Al analizar un archivo o aplicación maliciosa, podemos ver exactamente cómo funciona y, por lo tanto, saber cómo prevenirlo. Por ejemplo, ¿podría el archivo malicioso comunicarse con el servidor de un atacante? Podemos bloquear ese servidor. El malware causa estragos en TBFC.

¿Podría el archivo malicioso dejar rastros en el equipo? Podemos utilizarlos para determinar si el malware ha infectado otro dispositivo. En lugar de temer al malware, podemos adoptar un enfoque proactivo, convirtiendo los hallazgos técnicos en medidas defensivas prácticas y comprendiendo cómo el malware se integra en las técnicas de un atacante.

Existen dos ramas principales del análisis de malware: estática y dinámica. El análisis estático se centra en inspeccionar un archivo sin ejecutarlo, mientras que el análisis dinámico implica su ejecución. Las abordaremos en breve.

![[Pasted image 20251206154417.png]]

**Sandboxes**

En ciberseguridad, los sandboxes se utilizan para ejecutar código potencialmente peligroso. Piense en ellos como parques infantiles digitales desechables. Estos entornos aislados son entornos seguros y aislados donde las aplicaciones potencialmente maliciosas pueden ejecutar sus acciones sin poner en riesgo datos confidenciales ni afectar a otros sistemas.

El uso de entornos aislados forma parte de la regla de oro en el análisis de malware: nunca ejecute aplicaciones peligrosas en dispositivos importantes.

La mayoría de las veces, los entornos aislados se presentan como máquinas virtuales. Las máquinas virtuales son una opción popular para el sandboxing porque permiten controlar el funcionamiento del sistema y beneficiarse de funciones como la creación de instantáneas, que permite crear y restaurar la máquina a diferentes estados.

Reiteramos que es fundamental comprender que el código y las aplicaciones potencialmente maliciosos solo deben ejecutarse en un entorno seguro y aislado. De ahora en adelante, en esta sala nos referiremos al código y las aplicaciones maliciosos como ejemplos.

Una vez cubiertos estos fundamentos, pasemos a la sección práctica de la sala de hoy. A continuación, se mostrará un ejemplo; debe aplicar estas técnicas al archivo HopHelper.exe que se encuentra en la carpeta "HopHelper" del escritorio de la máquina virtual práctica.

![[Pasted image 20251206154745.png]]

## Interactivo: Análisis estático

Como mencionamos anteriormente en esta sala, utilizamos el análisis estático para recopilar información sobre una muestra sin ejecutarla ni analizarla en profundidad.

El análisis estático puede ser una forma rápida y eficaz de comprender cómo funciona la muestra y cómo identificarla. Parte de la información que se puede obtener del análisis estático se incluye en la siguiente tabla:

|                 |                                                                                                                                                                                                                                                                                                                                                                       |                                                                                 |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| **Information** | **Explanation**                                                                                                                                                                                                                                                                                                                                                       | **Example**                                                                     |
| Checksums       | Estas sumas de comprobación se utilizan en ciberseguridad para rastrear y catalogar archivos y ejecutables. Por ejemplo, puede buscar la suma de comprobación en Google para ver si se ha identificado antes.                                                                                                                                                         | `a93f7e8c4d21b19f2e12f09a5c33e48a`                                              |
| Strings         | Las "cadenas" son secuencias de caracteres legibles dentro de un ejecutable. Pueden ser, por ejemplo, direcciones IP, URL, comandos o incluso contraseñas.                                                                                                                                                                                                            | `138.62.51.186`                                                                 |
| Imports         | Las "importaciones" son una lista de bibliotecas y funciones de las que depende la aplicación. Por ejemplo, en lugar de compilar todo desde cero, las aplicaciones usarán funciones y bibliotecas del sistema operativo para interactuar con él.<br><br>Estos son útiles, especialmente en Windows, ya que permiten ver cómo la aplicación interactúa con el sistema. | `CreateFileW`<br><br>This library is used to create a file on a Windows system. |
| Resources       | Los "Recursos" contienen datos como el icono que se muestra al usuario. Es útil examinarlos, sobre todo porque el malware podría usar el icono de un documento de Word para engañar al usuario.<br>  <br>¡Además, se sabe que incluso malware se esconde en esta sección!                                                                                             | N/A                                                                             |

Sin embargo, es importante tener en cuenta que, independientemente de cómo se vea o funcione una muestra, no lo sabemos con certeza hasta que se ejecuta. Los atacantes utilizan técnicas como la ofuscación para ocultar la apariencia de la muestra, principalmente para evadir los antivirus, pero también para evitar a un analista curioso.

**Demostración de PeStudio**

En esta sección de la sala se mostrará cómo usar PeStudio con un ejemplo llamado ``downloader.exe``. Tenga en cuenta que la información que verá corresponderá a este ejemplo de demostración. La muestra que analizará será diferente, pero las técnicas se aplicarán.

Es fundamental que no inicie todavía el ejecutable ``HopHelper.exe``.

![[Pasted image 20251206154856.png]]

Primero, iniciaremos PeStudio y cargaremos el ejecutable. El acceso directo se encuentra en el escritorio de su equipo. Puede arrastrar y soltar el ejecutable en la ventana de PeStudio o cargarlo seleccionando Archivo -> Abrir archivo en la barra de herramientas. PeStudio mostrará información sobre el ejecutable.

![[Pasted image 20251206154935.png]]

En esta etapa, nos interesa la propiedad `file > sha256` dentro de la tabla. Este valor es una suma de comprobación, que es un identificador único del ejecutable. Podemos registrar este SHA256 como información sobre amenazas.

![[Pasted image 20251206155007.png]]

A continuación, revisaremos las cadenas del ejecutable. Puede hacerlo haciendo clic en el indicador de cadenas en el panel izquierdo de PeStudio.

![[Pasted image 20251206155252.png]]

En el contexto del análisis de malware, las cadenas son secuencias de caracteres legibles presentes en un ejecutable. Pueden ser, por ejemplo, direcciones IP, URL, comandos o incluso contraseñas. Como analista de malware, es fundamental examinarlas, ya que podrían revelar la infraestructura de comandos del atacante, lo cual podemos usar para nuestras defensas.

![[Pasted image 20251206155315.png]]

Tenga en cuenta que el cálculo de las "cadenas" puede tardar unos minutos.
¡Genial! Con esto concluye la parte práctica sobre análisis estático. Hay mucho más que descubrir con el análisis estático. Si lo desea, explore el tema. Pasemos al análisis dinámico a continuación.

## Interactivo: Análisis dinámico

Esta sección de la sala ofrece una breve introducción al análisis dinámico. Como recordará, el análisis dinámico implica ejecutar la muestra maliciosa para identificar su comportamiento y cómo interactúa con el sistema operativo.

**Regshot**

Regshot es una utilidad muy utilizada, especialmente al analizar malware en Windows. Funciona creando dos instantáneas del registro: una antes de ejecutar el malware y otra después. Los resultados se comparan para identificar cualquier cambio.

El malware busca la persistencia, es decir, se ejecuta en cuanto se enciende el dispositivo. Una técnica común para el malware es añadir una clave de ejecución al registro, que se utiliza con frecuencia para especificar qué aplicaciones se ejecutan automáticamente al encender el dispositivo.

![[Pasted image 20251206155351.png]]

Abramos Regshot y creemos una captura del registro tal como está actualmente. El acceso directo también se encuentra en el escritorio del equipo del analista.

Primero, cambie el directorio de salida de la captura al escritorio del usuario usando el cuadro con tres puntos en la sección "Ruta de salida".

Una vez configurado, creemos nuestra primera instantánea. Seleccione "1.ª captura" y luego "Captura" en el menú desplegable. Tenga en cuenta que esto puede tardar unos minutos.

![[Pasted image 20251206155416.png]]

![[Pasted image 20251206155428.png]]

Una vez ejecutada la muestra, volvamos a Regshot y capturemos nuestra segunda instantánea siguiendo el mismo procedimiento. Haga clic en el botón "Segunda captura" y seleccione "Captura" en el menú desplegable. Regshot volverá a capturar el registro y exportará las diferencias a un archivo.

![[Pasted image 20251206155501.png]]

Y ahora, después de unos segundos, presionemos el botón Comparar que aparece.

![[Pasted image 20251206155521.png]]

Podemos buscar el ejecutable en el registro que se abre.

**ProcMon**

A continuación, exploraremos el uso de ProcMon (Monitor de Procesos) de la suite Sysinternals para investigar el ejemplo de hoy. El Monitor de Procesos se utiliza para supervisar e investigar cómo interactúan los procesos con el sistema operativo Windows. Es una herramienta potente que nos permite ver exactamente qué está haciendo un proceso. Por ejemplo, leer y escribir claves de registro, buscar archivos o crear conexiones de red.

Abra el Monitor de Procesos (ProcMon). El acceso directo se encuentra en el escritorio del equipo del analista. El Monitor de Procesos comenzará a capturar automáticamente los eventos de varios procesos del sistema.

![[Pasted image 20251206155550.png]]

![[Pasted image 20251206155604.png]]

Tras esperar un minuto, asegurándonos de que la muestra se haya ejecutado por completo, detendremos la captura. Para detener la captura de más eventos, haga clic en el botón Reproducir en la barra de herramientas del Monitor de Procesos.

![[Pasted image 20251206155624.png]]

Como pueden ver, hay mucha información para explorar, con los eventos más recientes en la parte inferior. Aquí podemos ver cómo interactúan los distintos procesos del sistema con Windows. Casi nada nos interesa.

![[Pasted image 20251206155647.png]]

Apliquemos algunos filtros. Al fin y al cabo, para esta demostración, solo nos interesa el ejemplo downloader.exe. Para ello, haga clic en el botón Filtrar y, a continuación, en la opción Filtrar del menú desplegable.

![[Pasted image 20251206155715.png]]

Se abrirá una nueva ventana.

![[Pasted image 20251206155736.png]]

Aquí podemos crear filtros para eliminar el ruido que no nos interesa. Como solo queremos ver este ejemplo de downloader.exe para esta demostración, podemos aplicar un filtro como este:

1. Aplicar el filtro "Nombre del proceso"
2. Establecer la condición como "is"
3. Introducir el nombre del proceso que queremos ver en el área de texto
4. Pulsar el botón "Añadir" para aplicar este filtro
5. Y finalmente, hacer clic en "Aceptar" para guardar.

![[Pasted image 20251206155804.png]]

Una vez hecho esto, volviendo a la ventana principal de Process Monitor, ya podemos ver que el filtro ha funcionado.

![[Pasted image 20251206155825.png]]

Ahora es mucho más fácil investigar cómo interactúa el proceso con el sistema operativo. Aquí hay algunas operaciones que pueden ser de interés:

- RegOpenKey
- CreateFile
- TCP Connect
- TCP Receive

Sin embargo, como puede ver, aún hay mucha información. Podemos aplicar filtros adicionales para buscar elementos específicos que queramos investigar, como las operaciones mencionadas anteriormente.

Para ello, regrese al encabezado "Filtro" y cree el filtro que desea aplicar. Por ejemplo, podemos filtrar por "Operaciones". Hagamos lo mismo a continuación, filtrando por cualquier operación TCP:

![[Pasted image 20251206155901.png]]

Ahora veremos todas las operaciones que incluyen TCP. Recuerda que puedes eliminar los filtros que hayas aplicado previamente haciendo clic en el filtro en la lista de filtros y pulsando "Eliminar".

![[Pasted image 20251206155922.png]]

O, alternativamente, si desea comenzar de nuevo, puede simplemente presionar la opción Restablecer filtro al hacer clic en el encabezado Filtro.

![[Pasted image 20251206155947.png]]

¡Uf! ¡Bien hecho! Con esto concluye la demostración de la sala de hoy. Recuerda que tendrás que aplicar lo aprendido aquí en el ejecutable **HopHelper.exe**, ubicado en la carpeta HopHelper del escritorio del analista, para responder las preguntas a continuación.

**Answer the questions below**

**Static analysis:** What is the SHA256Sum of the HopHelper.exe?

Respuesta: F29C270068F865EF4A747E2683BFA07667BF64E768B38FBB9A2750A3D879CA33
![[Pasted image 20251206162011.png]]

**Static analysis:** Within the strings of HopHelper.exe, a flag with the format THM{XXXXX} exists. What is that flag value?

Note, this can be found towards the bottom of the strings output.

Respuesta: THM{STRINGS_FOUND}
![[Pasted image 20251206162155.png]]

**Dynamic analysis:** What registry value has the HopHelper.exe modified for persistence?

Note: Provide the full path of the key that has been modified

Respuesta: HKU\S-1-5-21-1966530601-3185510712-10604624-1008\Software\Microsoft\Windows\CurrentVersion\Run\HopHelper: "C:\Users\DFIRUser\Desktop\HopHelper\HopHelper.exe"
![[Pasted image 20251206165710.png]]

**Dynamic analysis**: Filter the output of ProcMon for "TCP" operations. What network protocol is HopHelper.exe using to communicate?

Make sure to have executed HopHelper.exe while ProcMon was open and capturing events.

Respuesta: http
![[Pasted image 20251206173223.png]]

**Bonus:** Can you find the web panel that HopHelper.exe is communicating with?

No necesita respuesta


If you enjoyed today's room, feel free to explore both the [Basic Static Analysis](https://tryhackme.com/room/staticanalysis1) and [Basic Dynamic Analysis](https://tryhackme.com/room/basicdynamicanalysis) rooms, where you can delve deeper into the techniques and tools discussed today.

No necesita respuesta